# PA5. Publisher-Subscriber (Издатель-Подписчик) для браузера

**Цель:** научиться организовывать взаимодействие с браузером на основе публикации событий на стороне сервера и подписки на них в браузере.

- Это необязательная лабораторная — вы можете пропустить её, выбрав другую лабораторную (всего предстоит выполнить 7 лабораторных работ)
- Задание делается на базе задания PA4

# Задание

>Ниже под *событием* понимается сообщение с информацией о событии, публикуемое в брокер сообщений или сервер сообщений.

После отправки текста на проверку пользователь перенаправляется на страницу Summary. Однако обработка текста может занять произвольное время, и на момент отображения страницы Summary результат может быть ещё не готов.

Необходимо:

1. Добавить случайную задержку от 3 до 15 секунд в обработчик в сервисе *RankCalculator*
2. Сделать страницу Summary динамической, обеспечив возможность загрузить результат сразу после его готовности
    - на стороне сервера следует использовать SignalR либо Centrifugo
    - страница должна использовать JavaScript для создания и использования WebSocket соединения с помощью клиентской библиотеки SignalR либо Centrifugo

## 1. Добавить ожидание

Добавить ожидание можно так:

```csharp
TimeSpan interval = TimeSpan.FromSeconds(new Random().Next(3, 15));
Console.WriteLine($"Waiting {interval}");
await Task.Delay(interval, ct);
```

## 2. Подключить SignalR либо Centrifugo

SignalR и Centrifugo — готовые системы промышленного уровня качества, предназначенные для двухсторонней передачи сообщений между клиентом (браузером) и сервером.

* Centrifugo обычно используется как отдельный компонент системы, который принимает соединения по WebSocket от клиентов (страниц в браузере) и позволяет другим сервисам инициировать отправку сообщений подключённым клиентам, выполнив HTTP-запрос от сервиса к Centrifugo
* SignalR встраивается в приложение, а в остальном работает аналогично — принимает соединения по WebSocket от клиентов (страниц в браузере) и позволяет программно инициировать отправку сообщений подключённым клиентам

## 3. Нарисовать C4 диаграмму контейнеров

Перед сдачей работы следует нарисовать C4 диаграмму контейнеров со всеми компонентами системы, включая браузер:

- диаграмму можно нарисовать на бумаге либо сделать в приложении [draw.io](https://github.com/jgraph/drawio-desktop/releases)
- на диаграмме предстоит показать, как взаимодействуют сервисы Valuator, RankCalculator и EventsLogger и показать рассылку сообщений (уведомлений) браузеру с помощью SignalR или Centrifugo

# Полезные ссылки

Для SignalR:

1. Руководство [Introduction to SignalR](https://learn.microsoft.com/en-us/aspnet/signalr/overview/getting-started/introduction-to-signalr) для C#/.NET
2. Серия статей [Основы SignalR](https://metanit.com/sharp/signalr/1.1.php) для C#/.NET

Для Centrifugo:

1. [Quickstart tutorial](https://centrifugal.dev/docs/getting-started/quickstart)
2. [Integration guide](https://centrifugal.dev/docs/getting-started/integration)

